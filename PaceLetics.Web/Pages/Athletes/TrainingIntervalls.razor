@page "/Athletes/trainingintervalls"

@using System.IO
@using AthleteDataAccessLibrary
@using AthleteDataAccessLibrary.Contracts
@using MudBlazor
@using PaceLetics.AthleteModule.CodeBase.Models
@using PaceLetics.VdotModule.CodeBase.Models
@using Paceletics.Domain.Training

@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject IAthleteData AthleteData
@inject IDialogService DialogService

<PageTitle>Mein nächstes Intervalltraining</PageTitle>

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.Medium">

    @if (_isLoading)
    {
        <LoadingScreen Label="Deine Daten werden geladen..." />
    }
    else
    {
        <MudPaper Class="pa-5 rounded-xl mb-6" Elevation="2">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Class="fw-bold">
                    Mein nächstes Intervalltraining
                </MudText>

                <MudText Typo="Typo.body1">
                    Diese Einheit ist anhand deines aktuellen Pace-Modells berechnet.
                </MudText>
            </MudStack>
        </MudPaper>

        <MudStack Spacing="3">

            @if (_athlete?.Vdot < 1 || _athlete?.PaceModel is null)
            {
                <MudAlert Severity="Severity.Warning">
                    Füge einen Einstufungslauf hinzu, damit wir deine optimale Trainingspace bestimmen können.
                </MudAlert>
            }
            else if (_currentTraining is null)
            {
                <MudAlert Severity="Severity.Info">
                    Es sind aktuell keine Intervalltrainings definiert.
                </MudAlert>
            }
            else
            {
                <MudPaper Class="pa-4 rounded-xl" Elevation="2">
                    <MudStack Spacing="2">

                        <MudStack Spacing="1">
                            <MudText Typo="Typo.h5" Class="fw-bold">
                                @_currentTraining.Name
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                ID: @_currentTraining.Id · Geplant am: @_currentTraining.Date.ToString("dd.MM.yyyy")
                            </MudText>
                        </MudStack>

                        <MudDivider />

           
                        <MudDivider />
                        <MudTable T="TableRow"
                                  Items="TableRows"
                                  Dense="true"
                                  Hover="true"
                                  Breakpoint="Breakpoint.Sm">
                            <HeaderContent>
                                <MudTh>#</MudTh>
                                <MudTh>Distanz</MudTh>
                                <MudTh>Pacebereich</MudTh>
                                <MudTh>Pace</MudTh>
                                <MudTh>Intervallzeit</MudTh>
                                <MudTh>Rundenzeit (400m)</MudTh>
                            </HeaderContent>

                            <RowTemplate Context="row">

                                @if (!row.IsPause)
                                {
                                    <!-- INTERVALL -->
                                    
                                        var i = row.Index;
                                        var dist = _currentTraining!.Distances[i];
                                        var key = _currentTraining.PaceKeys[i];
                                        var pace = _currentTraining.Paces[i];
                                        var interval = _currentTraining.IntervallTime[i];
                                        var lap = _currentTraining.LabTime[i];
                                    
                                    <MudTd DataLabel="#">@(i + 1)</MudTd>
                                    <MudTd DataLabel="Distanz">@dist m</MudTd>
                                    <MudTd DataLabel="Pacebereich">@key</MudTd>
                                    <MudTd DataLabel="Pace">@pace.ToString(@"mm\:ss") / km</MudTd>
                                    <MudTd DataLabel="Intervallzeit">@interval.ToString(@"mm\:ss")</MudTd>
                                    <MudTd DataLabel="Rundenzeit">@lap.ToString(@"mm\:ss")</MudTd>
                                }
                                else
                                {
      
                                        var i = row.Index;
                                        var recDist = _currentTraining!.Recovery[i];
                                        var pace = _athlete!.PaceModel!.Easy; // Pause-Pace
                                        var recTime = TimeSpan.FromSeconds(Math.Round(recDist * pace.TotalSeconds / 1000.0));
                                    

                                    <MudTd DataLabel="#"></MudTd>
                                    <MudTd DataLabel="Distanz"><b>Pause</b> @recDist m</MudTd>
                                    <MudTd DataLabel="Pacebereich">—</MudTd>
                                    <MudTd DataLabel="Pace">@pace.ToString(@"mm\:ss") / km</MudTd>
                                    <MudTd DataLabel="Pausezeit">@recTime.ToString(@"mm\:ss")</MudTd>
                                    <MudTd DataLabel="Rundenzeit">—</MudTd>
                                }
                            </RowTemplate>
                        </MudTable>



                    </MudStack>
                </MudPaper>
            }
        </MudStack>
    }

</MudContainer>

@code {
    private bool _isLoading = true;

    private AthleteModel? _athlete;
    private IntervallTraining? _currentTraining;

    /// <summary>
    /// Indizes der Intervalle für das aktuelle Training, für das MudTable-Items-Binding.
    /// </summary>
    private IEnumerable<int> IntervalIndices =>
        _currentTraining is null
            ? Enumerable.Empty<int>()
            : Enumerable.Range(0, _currentTraining.Distances.Count);


    private record TableRow(bool IsPause, int Index);
    private IEnumerable<TableRow> TableRows =>
        Enumerable.Range(0, _currentTraining!.Distances.Count)
            .SelectMany(i =>
            {
                var list = new List<TableRow> { new(false, i) };
                if (i < _currentTraining.Recovery.Count && _currentTraining.Recovery[i] > 0)
                    list.Add(new(true, i));
                return list;
            });

    // Relativer Pfad zur JSON-Datei im Output (bin/..)
    private const string IntervalsJsonRelativePath = "res/intervals.json";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
            var userID = authState.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;

            if (string.IsNullOrEmpty(userID))
            {
                await DialogService.ShowInformationAsync(
                    "Achtung",
                    "Du bist nicht eingeloggt. Bitte melde dich erneut an.",
                    Icons.Material.Filled.Error);
                return;
            }

            _athlete = await AthleteData.GetAthlete(userID);

            // Wenn kein PaceModel vorhanden ist, brauchen wir gar nicht erst Trainings laden
            if (_athlete?.PaceModel is null)
                return;

            // JSON aus res/intervals.json laden (liegt im Output-Verzeichnis)
            var baseDir = AppContext.BaseDirectory;
            var jsonPath = "wwwroot/data/intervalls.json";

            var trainings = IntervallTrainingFactory.LoadFromJsonFile(jsonPath);

            // Nächstes Training finden:
            // 1) Frühestes Training mit Date >= heute
            // 2) Falls keins, letzte vergangene Einheit als Fallback
            var today = DateTime.Today;
            var upcoming = trainings
                .Where(t => t.Date.Date >= today)
                .OrderBy(t => t.Date)
                .FirstOrDefault();

            var selected = upcoming ?? trainings.OrderByDescending(t => t.Date).FirstOrDefault();

            if (selected is not null)
            {
                _currentTraining = CloneAndApplyPace(selected, _athlete.PaceModel);
            }
        }
        catch
        {
            await DialogService.ShowInformationAsync(
                "Achtung",
                "Es gab ein Problem beim Laden deiner Daten oder der Intervall-Definitionen. Bitte versuche es später erneut.",
                Icons.Material.Filled.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Erzeugt aus einem Template eine "personalisierte" Kopie mit angewendetem PaceModel.
    /// </summary>
    private static IntervallTraining CloneAndApplyPace(IntervallTraining template, PaceModel paceModel)
    {
        var t = new IntervallTraining(
            template.Id,
            template.Name,
            template.Date,
            template.Distances,
            template.Recovery,
            template.PaceKeys,
            template.Sets,
            template.SetRecovery);

        t.ApplyPaceModel(paceModel);
        return t;
    }
}

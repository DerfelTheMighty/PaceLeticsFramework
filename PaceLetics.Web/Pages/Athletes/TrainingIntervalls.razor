@page "/Athletes/trainingintervalls"

@using System.IO
@using AthleteDataAccessLibrary
@using AthleteDataAccessLibrary.Contracts
@using MudBlazor
@using PaceLetics.AthleteModule.CodeBase.Models
@using PaceLetics.CoreModule.Infrastructure.Models
@using PaceLetics.RunningModule.CodeBase.Models

@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject IAthleteData AthleteData
@inject IDialogService DialogService

<PageTitle>Dein nächstes Intervalltraining</PageTitle>

<MudContainer Class="pt-6 px-6 pb-8" MaxWidth="MaxWidth.Small">

    @if (_isLoading)
    {
        <LoadingScreen Label="Deine Daten werden geladen..." />
    }
    else
    {
        <PageHeader Title="Dein nächstes Intervalltraining"
                    Subtitle="Diese Einheit ist anhand deines aktuellen Pace-Modells berechnet.." />

        <MudDivider Class="my-4" />

        <MudStack Spacing="3">

            @if (_athlete?.Vdot < 1 || _athlete?.PaceModel is null)
            {
                <MudAlert Severity="Severity.Warning">
                    Füge einen Einstufungslauf hinzu, damit wir deine optimale Trainingspace bestimmen können.
                </MudAlert>
            }
            else if (_currentTraining is null)
            {
                <MudAlert Severity="Severity.Info">
                    Es sind aktuell keine Intervalltrainings definiert.
                </MudAlert>
            }
            else
            {
                <MudPaper Class="pa-4 rounded-xl" Elevation="2">
                    <MudStack Spacing="2">

                        <MudStack Spacing="1">
                            <MudText Typo="Typo.h5" Class="fw-bold">
                                @_currentTraining.Name
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                ID: @_currentTraining.Id · Geplant am: @_currentTraining.Date.ToString("dd.MM.yyyy")
                            </MudText>
                        </MudStack>

                        <MudDivider />

           
                        <MudDivider />

                    </MudStack>
                </MudPaper>
            }
        </MudStack>
    }

</MudContainer>

@code {
    private bool _isLoading = true;

    private AthleteModel? _athlete;
    private IntervallSession? _currentTraining;

    /// <summary>
    /// Indizes der Intervalle für das aktuelle Training, für das MudTable-Items-Binding.
    /// </summary>
    private IEnumerable<int> IntervalIndices =>
        _currentTraining is null
            ? Enumerable.Empty<int>()
            : Enumerable.Range(0, _currentTraining.Distances.Count);


    private record TableRow(bool IsPause, int Index);
    private IEnumerable<TableRow> TableRows =>
        Enumerable.Range(0, _currentTraining!.Distances.Count)
            .SelectMany(i =>
            {
                var list = new List<TableRow> { new(false, i) };
                if (i < _currentTraining.Recovery.Count && _currentTraining.Recovery[i] > 0)
                    list.Add(new(true, i));
                return list;
            });

    // Relativer Pfad zur JSON-Datei im Output (bin/..)
    private const string IntervalsJsonRelativePath = "res/intervals.json";

    protected override async Task OnInitializedAsync()
    {

        var authState = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
        var userID = authState.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;

        if (string.IsNullOrEmpty(userID))
        {
            await DialogService.ShowInformationAsync(
                "Achtung",
                "Du bist nicht eingeloggt. Bitte melde dich erneut an.",
                Icons.Material.Filled.Error);
            return;
        }

        _athlete = await AthleteData.GetAthlete(userID);

        // Wenn kein PaceModel vorhanden ist, brauchen wir gar nicht erst Trainings laden
        if (_athlete?.PaceModel is null)
            return;

        // JSON aus res/intervals.json laden (liegt im Output-Verzeichnis)
        var baseDir = AppContext.BaseDirectory;
        var jsonPath = "wwwroot/data/intervalls.json";

            
        var sessions = RunningSessionFactory.Load(jsonPath);
		var resolved = new List<ResolvedRunningSession>();
        foreach (var session in sessions.OrderBy(s => s.Date))
        {
            resolved.Add(RunningSessionResolver.Resolve(session, _athlete.PaceModel));
           
        }

        var today = DateTime.Today;
        var upcoming = sessions
            .Where(t => t.Date.Date >= today)
            .OrderBy(t => t.Date)
            .FirstOrDefault();

        var selected = upcoming ?? sessions.OrderByDescending(t => t.Date).FirstOrDefault();


    }

    
}
